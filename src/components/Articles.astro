---
import fetch from 'node-fetch';
import type { OgpData } from '../types';
import type { Lang } from '../i18n/config';
import { useTranslations } from '../i18n/utils';
import { getArticlesData } from '../data';

interface Props {
  lang: Lang;
}

const { lang } = Astro.props;
const t = useTranslations(lang);
const articles = getArticlesData(lang);

async function getOgp() {
  const ogps: OgpData[] = [];
  for (const article of articles) {
    // OGPを取得
    try {
      const res = await fetch(article.url);
      const html = await res.text();
      const ogTitleMatch = html.match(/<meta[^>]*property=["']og:title["'][^>]*content=["']([^"']*?)["'][^>]*>/i);
      const ogDescMatch = html.match(/<meta[^>]*property=["']og:description["'][^>]*content=["']([^"']*?)["'][^>]*>/i);
      const ogImageMatch = html.match(/<meta[^>]*property=["']og:image["'][^>]*content=["']([^"']*?)["'][^>]*>/i);

      const ogp: OgpData = {
        'og:title': article.title || ogTitleMatch?.[1]?.replace(/&quot;/g, '"').replace(/&amp;/g, '&') || 'Article',
        'og:description': article.description || ogDescMatch?.[1]?.replace(/&quot;/g, '"').replace(/&amp;/g, '&') || null,
        'og:url': article.url,
        'og:image': article.image || ogImageMatch?.[1] || null
      };
      ogps.push(ogp);
    } catch (error) {
      ogps.push({
        'og:title': article.title || 'Article',
        'og:description': article.description || 'External article',
        'og:url': article.url,
        'og:image': article.image || null
      });
    }
  };
  return ogps;
};
const ogps = await getOgp();
---

<div id="articles" class="w-full px-4 md:px-8 lg:px-16 flex flex-col items-center">
  <div class="w-full text-center">
    <h2 class="text-3xl my-4 font-bold text-gray-900 leading-tight mb-2 border-t-4 border-b-4 border-gray-600 py-4">{t('articles.title')}</h2>
    <div>
      <div class="grid lg:grid-cols-3 gap-4 md:grid-cols-2 grid-cols-1">
        { ogps.map((ogp) =>
          <div class="bg-white p-4 rounded-lg shadow-md">
          <a href={ogp['og:url']} class="hover:shadow-lg" target="_blank" rel="noopener noreferrer">
            <div class="text-center justify-center flex flex-col">
              <img src={ogp['og:image']} class="h-24 mx-auto">
              <h3 class="text-md font-semibold mt-2">{ ogp['og:title'] }</h3>
            </div>
            <p class="mt-4 text-sm wrap-normal">{ ogp['og:description'] }</p>
          </a>
          </div>
          )
        }
      </div>
    </div>
  </div>
</div>
